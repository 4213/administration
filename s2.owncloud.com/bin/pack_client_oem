#!/bin/sh
# 
# Repo at github.com:owncloud/administration.git/s2.owncloud.com/bin
#
# 2014-07-18, jw -- split_debug feature added.
# 2014-07-28, jw -- printing userfriendly upload and rm commands at the end.
# 2014-08-06, jw -- calling check_packed_client_oem.pl to assert right version.
# 2014-08-13, jw -- proper splitting without adduming there is exactly one CentOS
#                   dest folder mapping added: surfcloudlinuxupdater goes to surfcloud.

if [ $# -ne 2 ]
  then
    echo "Call with arguments oem-name and version!"
    exit 1
fi

mydir=$(realpath $(dirname $0))

oem=$1
version=$2

# comment this line to disable split_debug
split_debug=split_debug

echo "Packaging linux client tarball for $oem version $version"

if true; then
# copy the build repos to a temporar space
rm -rf /tmp/$oem
mkdir /tmp/$oem

echo "from /srv/obs/repos/oem:/$oem/ ..."
cp -a /srv/obs/repos/oem\:/$oem/* /tmp/$oem
rm -rf /tmp/$oem/*/repocache

# ...and fix the baseurl string in the repo files.
# find /tmp/$oem -name "*repo" | xargs sed -i 's#repositories/oem:#repositories#'

mv /tmp/$oem /tmp/$oem-$version
fi

cd /tmp/$oem-$version
# strip toolchain packages.
find . \( -name cmake-\* \)  | xargs rm -f

# package into tar balls.
if [ x$split_debug != x ]; then
  find . \( -name \*-debuginfo\* -o -name \*src.rpm \) > debug.list
  mkdir -p debug/$oem-$version
  ## FIXME mv would be more efficient than cpio + rm. 
  ## But how can we mv with preserving hierarchy?
  cpio -pdm debug/$oem-$version/ < debug.list
  xargs rm -f < debug.list
  rm debug.list
  (cd debug; tar cf /tmp/$oem-$version-debug.tar $oem-$version)
  rm -rf debug
fi

## we may have multiple CentOS* directories. They are fat. We create a tar for each of them.
for centos in CentOS*; do
  test -d $centos || continue;	# we come here with an unexpanded Centos* if nothing matches.
  (cd ..; tar cf /tmp/$oem-$version-$centos.tar $oem-$version/$centos)
  rm -rf $centos
done
cd /tmp
tar cf /tmp/$oem-$version-linux.tar $oem-$version/*

# ... and remove the tmp
rm -rf /tmp/$oem-$version

for tar in /tmp/$oem-$version*.tar; do
  $mydir/check_packed_client_oem.pl $tar || exit 1;
done

ls -la /tmp/$oem-$version*

# end.

function dest_folder ()
{
  tar=$1
  brand=$(expr match $tar '.*/\(\w\+\)-')

  case "$brand" in
    surfcloudlinuxupdater) echo surfcloud ;;
    surfcloudlinux) echo surfcloud ;;
    *) echo $brand ;;
  esac
  exit 1	# not reached.
}

# We split the commands in half, if we use the splitdebug feature, so that the user can do copy/paste and 
# skip 1.8G debug packages per branding.
normal=$(ls /tmp/*-*-*.tar | grep -v .debug.tar)
debug=$(ls /tmp/*-*-debug.tar)

echo "You can now copy the packages to dl-oc -- use these commands or similar:"
if [ "x$debug" != x ]; then
  for tar in $debug; do
    oem=$(dest_folder $tar)
    echo rsync -rzv --progress --delete $tar root@download.owncloud.com:/srv/www/htdocs/desktop/projects/$oem
  done
  echo ""
fi
for tar in $normal; do
  oem=$(dest_folder $tar)
  echo rsync -rzv --progress --delete $tar root@download.owncloud.com:/srv/www/htdocs/desktop/projects/$oem
done
echo rm -f /tmp/$oem-$version-\*.tar 
