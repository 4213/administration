#!/bin/sh
# 
# Repo at github.com:owncloud/administration.git/s2.owncloud.com/bin
#
# 2014-07-18, jw -- split_debug feature added.
# 2014-07-28, jw -- printing userfriendly upload and rm commands at the end.


if [ $# -ne 2 ]
  then
    echo "Call with arguments oem-name and version!"
    exit 1
fi

oem=$1
version=$2

# comment this line to disable split_debug
split_debug=split_debug

echo "Packaging linux client tarball for $oem version $version"

# copy the build repos to a temporar space
rm -rf /tmp/$oem
mkdir /tmp/$oem

cp -a /srv/obs/repos/oem\:/$oem/* /tmp/$oem
rm -rf /tmp/$oem/*/repocache

# ...and fix the baseurl string in the repo files.
# find /tmp/$oem -name "*repo" | xargs sed -i 's#repositories/oem:#repositories#'

mv /tmp/$oem /tmp/$oem-$version

# package
cd /tmp
if [ -d $oem-$version/CentOS* ]
then
  if [ x$split_debug != x ]; then
    debugdir=$(ls -d $oem-$version/CentOS*).debug
    mkdir -p $oem-$version/debug
    (cd $oem-$version/CentOS_CentOS* ; find . \( -name \*-debuginfo\* -o -name \*src.rpm \) > ../debug.list )
    ## FIXME mv would be more efficient than cpio + rm. 
    ## But how can we mv with preserving hierarchy?
    echo Splitting debug packages
    (cd $oem-$version/CentOS_CentOS* ; cpio -pdmv < ../debug.list ../debug )
    (cd $oem-$version/CentOS_CentOS* ; xargs rm -f < ../debug.list )
    mv $oem-$version/debug $debugdir
    rm $oem-$version/debug.list

    tar cf /tmp/$oem-$version-centos6.debug.tar $debugdir
    [ $? -eq 0 ] && rm -rf $debugdir
  fi
  tar cf /tmp/$oem-$version-centos6.tar $oem-$version/CentOS*
  [ $? -eq 0 ] && rm -rf $oem-$version/CentOS*
fi
tar cf /tmp/$oem-$version-linux.tar $oem-$version/*

# ... and remove the tmp
rm -rf /tmp/$oem-$version

for tar in /tmp/$oem-$version*.tar; do
  check_packed_client_oem.pl $tar || exit 1;
done

ls -la /tmp/$oem-$version*

# end.

# We split the commands in half, if we use the splitdebug feature, so that the user can do copy/paste and 
# skip 1.8G debug packages per branding.
normal=$(ls /tmp/$oem-$version-*.tar | grep -v .debug.tar)

echo "You can now copy the packages to dl-oc -- use these commands or similar:"
if [ x$split_debug != x ]; then
  echo rsync -rzv --delete /tmp/$oem-$version-*.debug.tar root@download.owncloud.com:/srv/www/htdocs/desktop/projects/$oem
fi
echo rsync -rzv --delete $normal root@download.owncloud.com:/srv/www/htdocs/desktop/projects/$oem
echo rm -f /tmp/$oem-$version-*.tar 
