#!/bin/sh
#
# Maintained at: https://github.com/owncloud/administration/tree/master/s2.owncloud.com/bin
#

# copy the build repos to a temporary space
major=6
download_path=download/repositories/$major.0 
download_url="http://ownCloudEE:customer42!@download.ownCLOUD.com/$download_path"

tmp=/tmp/_publishee$major.$$
rm -rf $tmp/ee$major
mkdir -p $tmp/ee$major
set -x

rsync -ratzvatz /srv/obs/repos/ee\:/$major.0/* $tmp/ee$major

# ...and fix the baseurl string in the repo files.
# This is what we expect to see coming from s2, or similar...
# baseurl=http://USERNAME:PASSWORD@s2.owncloud.com:83//ee:/6.0/openSUSE_13.1/
# baseurl=https://download.owncloud.com/download/repositories/6.0/CentOS_CentOS-6/
#
find $tmp/ee$major -name "*.repo" | xargs sed -i "s#=.*/$major.0/#=$download_url/#"


# finally rsync to download server
rsync -rzv --delete $tmp/ee$major/* root@dl-oc.owncloud.com:/srv/www/htdocs/$download_path

# ... and remove the tmp
rm -rf $tmp/ee$major

echo Download url: $download_url
# end.

