#!/bin/sh
#
# Maintained at: https://github.com/owncloud/administration/tree/master/s2.owncloud.com/bin
#

# copy the build repos to a temporary space
major=7
download_path=download/repositories/$major.0 
download_url="http://ownCloudEE:customer42!@download.ownCloud.com/$download_path"

tmp=/tmp/_publishee$major.$$
rm -rf $tmp/ee$major
mkdir -p $tmp/ee$major
set -x

rsync -ratzvatz --exclude openssl\* --exclude oc-eval-license\* --exclude php5-APCu\* --exclude images\* /srv/obs/repos/ee\:/$major.0/* $tmp/ee$major

# ...and fix the baseurl string in the repo files.
# This is what we expect to see coming from s2, or similar...
# baseurl=http://USERNAME:PASSWORD@s2.owncloud.com:83//ee:/7.0/openSUSE_13.1/
# baseurl=https://download.owncloud.com/download/repositories/7.0/CentOS_CentOS-6/
#
find $tmp/ee$major -name "*.repo" | xargs sed -i "s#=.*/$major.0/#=$download_url/#"
# must not be there:
find $tmp/ee$major -name "oc-eval-license*" | xargs rm -f

# finally rsync to download server
#Thu Nov  6 17:17:19 EST 2014 - draht:
# DO NOT use download.owncloud.com, this refers to all of the download servers.
# your chances to get this actually placed where you want it are 25%.
# I have generically revoked access to all download.owncloud.com servers except
# for the master.
rsync -rzv --delete $tmp/ee$major/* root@dl-oc.owncloud.com:/srv/www/htdocs/$download_path

# ... and remove the tmp
rm -rf $tmp/ee$major

echo Download url: $download_url
# end.

