#!/bin/sh
#
# Maintained at: https://github.com/owncloud/administration/tree/master/s2.owncloud.com/bin
# run muliple times per day by root crontab @ s2.
#
# 2014-10-17, jw@owncloud.com
#
# Requires: zip
# Requires: qemu-img fom qemu-tools
# Requires: ovftool 
#  Installation procedure: (ovftool, 40MB from VMware)
#  https://developercenter.vmware.com/tool/ovf/3.5.0
#  yes | sudo sh VMware-ovftool-3.5.0-1274719-lin.x86_64.bundle | cat
#   -> unpacks to /usr/lib/vmware-installer/ /usr/lib/vmware-ovftool/ /etc/vmware* /usr/bin/ovftool
#
# 2014-10-21, jw using ovftool --lax option to help with vsphere hardware checks.


srcdir=/srv/obs/repos/ee\:/7.0/images
destdir=internal/eval-appliance/oc7ee/
destdir_daily=internal/eval-appliance/oc7ee-daily/
tempdir=/var/run/publish
dir=$tempdir/eval-$$
mkdir -p $dir

set -x

# pull all that are not raw tar balls into the temp.
# rsync -ratzvatz --exclude '*-raw.*' --delete-delay $srcdir/ $dir

## unpack the raw tar balls, most of them do not contain a raw image, but one of the other VHD or OVA formats.
# for raw in $srcdir/*-raw.tar.bz2; do
#   # Caution: Are overwrites dangerous here?
#   tar xvf $raw -C $dir
# done

for vmx in $srcdir/*-vmx.tar.bz2; do
  mkdir $dir/vmx
  archive_name=$(basename $vmx -vmx.tar.bz2)
  tar xvf $vmx -C $dir/vmx
  zip --junk-paths $dir/$archive_name.vmx.zip $dir/vmx/*
  mkdir $dir/ova
  ovftool --lax $dir/vmx/*.vmx $dir/ova/$archive_name.ova
  rm -rf $dir/vmx
  zip --junk-paths $dir/$archive_name.ova.zip $dir/ova/*
  rm -rf $dir/ova
done

for qcow2 in $srcdir/*.qcow2; do
  archive_name=$(basename $qcow2 .qcow2)
  zip --junk-paths $dir/$archive_name.qcow2.zip $qcow2

  ## If this generates bad vhd disks, we can also create 
  ## them from *.vmdk instead of from *.qcow2
  qemu-img convert $qcow2 $dir/$archive_name.vhd
  # prepare a nice *.XML to go into the zip with the vhd file?
  zip --junk-paths $dir/$archive_name.vhd.zip $dir/$archive_name.vhd
  rm $dir/$archive_name.vhd
done

# in $HOME/vhd we have *.XML files that may help with vhd.
if [ -d "$HOME/vhd" ]; then 
  cp -a $HOME/vhd $dir 
fi

mkdir -p ${srcdir}_zip
ls -la $dir
# push back to s2
rsync -ratzvatz --exclude '*-raw.*' --delete-delay $dir/ ${srcdir}_zip
chown -R obsrun:obsrun ${srcdir}_zip

mkdir $dir/daily
mv $dir/*daily*.zip $dir/daily

# stow away checksums in a subdirectory. Having so many files is confusing.
mkdir $dir/SHA256
for zip in $dir/*.zip; do
  file=$(basename $zip .zip)
  # no path names in sha256 files
  sha256sum $zip | sed -e 's@\s.*/@ @' > $dir/SHA256/$file.sha256
done
mkdir $dir/daily/SHA256
for zip in $dir/daily/*.zip; do
  file=$(basename $zip .zip)
  sha256sum $zip | sed -e 's@\s.*/@ @' > $dir/daily/SHA256/$file.sha256
done


# push everything (that is not a raw image) to the download server.
rsync -ratzvatz --exclude '*-raw.*' --delete-delay $dir/daily/ root@download.owncloud.com:/srv/www/htdocs/$destdir_daily

rm -rf $dir/daily

rsync -ratzvatz --exclude '*-raw.*' --delete-delay $dir/ root@download.owncloud.com:/srv/www/htdocs/$destdir

rm -rf $dir
set +x

echo ""
echo "Download urls: http://download.owncloud.com/$destdir"
echo "               http://download.owncloud.com/$destdir_daily"
# end.
